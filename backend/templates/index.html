<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelæ™ºèƒ½åˆ†æç³»ç»Ÿ - APIç‰ˆæœ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .system-status {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
        }

        .status-item {
            display: inline-block;
            margin: 0 15px;
            font-size: 14px;
        }

        .status-ok { color: #4CAF50; }
        .status-warning { color: #FF9800; }
        .status-error { color: #F44336; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
            min-height: 600px;
        }
        
        .chat-container {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            height: 600px;
            position: relative;
        }
        
        .chat-header {
            background: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-messages {
            flex: 1;
            background: white;
            padding: 20px;
            overflow-y: auto;
            min-height: 400px;
            max-height: 400px;
            border-left: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
        }
        
        .chat-input-area {
            background: white;
            padding: 15px 20px;
            border-radius: 0 0 10px 10px;
            border-top: 2px solid #dee2e6;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            resize: none;
            min-height: 20px;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        .chat-send-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        
        .chat-send-btn:hover:not(:disabled) {
            background: #45a049;
        }
        
        .chat-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .message.user .message-avatar {
            background: #4CAF50;
            color: white;
        }
        
        .message.assistant .message-avatar {
            background: #2196F3;
            color: white;
        }
        
        .message.system .message-avatar {
            background: #FF9800;
            color: white;
        }
        
        .message-content {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        
        .message.user .message-content {
            background: #4CAF50;
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.assistant .message-content {
            background: #e3f2fd;
            color: #333;
            border-bottom-left-radius: 5px;
        }
        
        .message.system .message-content {
            background: #fff3e0;
            color: #e65100;
            border-bottom-left-radius: 5px;
            border-left: 3px solid #FF9800;
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
            text-align: center;
        }
        
        .thinking-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 15px;
            color: #666;
            font-style: italic;
        }
        
        .thinking-indicator.show {
            display: flex;
        }
        
        .thinking-dots {
            display: flex;
            gap: 3px;
        }
        
        .thinking-dot {
            width: 6px;
            height: 6px;
            background: #666;
            border-radius: 50%;
            animation: thinking 1.5s ease-in-out infinite;
        }
        
        .thinking-dot:nth-child(2) {
            animation-delay: 0.3s;
        }
        
        .thinking-dot:nth-child(3) {
            animation-delay: 0.6s;
        }
        
        @keyframes thinking {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        
        /* Progress indicator styles */
        .progress-indicator {
            display: none;
            background: white;
            margin: 15px 0;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid #4CAF50;
            animation: slideIn 0.3s ease-out;
            position: relative;
        }
        
        .progress-indicator.show {
            display: block;
        }

        .progress-indicator.completed {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            max-height: 100px;
            overflow: hidden;
            transition: max-height 0.3s ease;
            cursor: pointer;
        }

        .progress-indicator.completed.expanded {
            max-height: none;
            cursor: default;
        }

        .progress-toggle-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s;
            z-index: 10;
        }

        .progress-toggle-btn:hover {
            background: #218838;
            transform: scale(1.1);
        }

        .progress-indicator.completed .progress-toggle-btn {
            background: #6c757d;
        }

        .progress-indicator.completed .progress-toggle-btn:hover {
            background: #5a6268;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .progress-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .progress-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .progress-title {
            flex: 1;
        }
        
        .progress-title h4 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }
        
        .progress-title p {
            margin: 5px 0 0 0;
            font-size: 13px;
            color: #666;
        }
        
        .progress-bar-container {
            background: #f0f0f0;
            border-radius: 10px;
            height: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.5s ease-out;
            border-radius: 10px;
        }
        
        .progress-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .progress-step.completed {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .progress-step.in-progress {
            background: #fff3e0;
            color: #e65100;
            animation: pulse 2s infinite;
        }
        
        .progress-step.failed {
            background: #ffebee;
            color: #c62828;
        }
        
        .progress-step.warning {
            background: #fff3e0;
            color: #ef6c00;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .progress-step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }
        
        .progress-step.pending .progress-step-icon {
            background: #ccc;
            color: white;
        }
        
        .progress-step.in-progress .progress-step-icon {
            background: #ff9800;
            color: white;
            animation: spin 1s linear infinite;
        }
        
        .progress-step.completed .progress-step-icon {
            background: #4caf50;
            color: white;
        }
        
        .progress-step.failed .progress-step-icon {
            background: #f44336;
            color: white;
        }
        
        .progress-step.warning .progress-step-icon {
            background: #ff9800;
            color: white;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-step-content {
            flex: 1;
        }
        
        .progress-step-name {
            font-weight: 500;
            margin-bottom: 2px;
        }
        
        .progress-step-description {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .progress-step-agent {
            font-size: 11px;
            color: #666;
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 10px;
        }

        .progress-step-details {
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
            border-left: 3px solid #dee2e6;
            display: none;
        }

        .progress-step.expanded .progress-step-details {
            display: block;
        }

        .step-input-output {
            margin: 5px 0;
        }

        .step-input-output strong {
            color: #495057;
            display: block;
            margin-bottom: 3px;
        }

        .step-data {
            background: white;
            padding: 6px 8px;
            border-radius: 3px;
            border: 1px solid #dee2e6;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 11px;
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .progress-step-expand-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
            transition: all 0.2s;
            margin-left: 8px;
        }

        .progress-step-expand-btn:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .welcome-message {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-style: italic;
        }
        
        .chat-disabled-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            z-index: 10;
        }
        
        .chat-disabled-overlay.show {
            display: flex;
        }

        .preview-controls {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            border: 1px solid #dee2e6;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-label {
            font-size: 13px;
            font-weight: 500;
            color: #495057;
        }

        .control-select {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            min-width: 150px;
            cursor: pointer;
        }

        .control-select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .control-select:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
        }

        .control-btn {
            padding: 6px 12px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
        }

        .control-btn:hover:not(:disabled) {
            background: #45a049;
        }

        .control-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .control-btn.secondary {
            background: #6c757d;
        }

        .control-btn.secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .preview-info {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 13px;
            color: #6c757d;
            border-left: 3px solid #4CAF50;
        }

        .preview-loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .preview-loading.show {
            display: block;
        }

        .preview-loading .spinner {
            width: 30px;
            height: 30px;
            margin: 0 auto 15px;
        }

        .file-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .file-tab {
            padding: 8px 16px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            color: #6c757d;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .file-tab.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
        }

        .file-tab:hover:not(.active) {
            color: #495057;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .upload-zone {
            text-align: center;
            margin-bottom: 20px;
        }

        .upload-icon {
            font-size: 3em;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .upload-btn:hover {
            background: #45a049;
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .file-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .query-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
        }

        .query-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            resize: vertical;
            min-height: 120px;
        }

        .query-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .query-btn {
            background: #2196F3;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background 0.3s;
        }

        .query-btn:hover {
            background: #1976D2;
        }

        .query-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .response-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-top: 30px;
            min-height: 300px;
        }

        .response-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #4CAF50;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #f44336;
            margin: 10px 0;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
            margin: 10px 0;
        }

        .warning {
            background: #fff3e0;
            color: #ef6c00;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ff9800;
            margin: 10px 0;
        }

        .sample-queries {
            margin-top: 20px;
        }

        .sample-query {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            border: 1px solid #dee2e6;
        }

        .sample-query:hover {
            background: #e3f2fd;
        }

        .workflow-status {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #2196F3;
        }

        .workflow-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .step-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .step-pending { background: #ccc; }
        .step-running { background: #ff9800; }
        .step-completed { background: #4caf50; }
        .step-error { background: #f44336; }

        .tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            color: #6c757d;
            transition: all 0.3s;
        }

        .tab.active {
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .mock-mode-banner {
            background: #fff3e0;
            color: #e65100;
            padding: 10px 20px;
            text-align: center;
            border-left: 4px solid #ff9800;
            margin-bottom: 20px;
        }

        /* Keywords analysis styles */
        .keywords-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
        }

        .keywords-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .keywords-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .keywords-refresh-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s;
        }

        .keywords-refresh-btn:hover:not(:disabled) {
            background: #45a049;
        }

        .keywords-refresh-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .keywords-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }

        .keywords-summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }

        .sheet-keywords {
            margin-bottom: 30px;
        }

        .sheet-header {
            background: #e3f2fd;
            padding: 12px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sheet-title {
            font-size: 16px;
            font-weight: bold;
            color: #1565C0;
        }

        .sheet-stats {
            font-size: 13px;
            color: #666;
        }

        .keywords-section {
            margin-bottom: 20px;
        }

        .keywords-section h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }

        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .keyword-tag {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .keyword-tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .keyword-weight {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .top-words-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .word-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #4CAF50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .word-text {
            font-weight: 500;
        }

        .word-count {
            background: #4CAF50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .keywords-loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .keywords-loading.show {
            display: block;
        }

        .keywords-error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #f44336;
            text-align: center;
        }

        .no-keywords {
            text-align: center;
            padding: 40px;
            color: #666;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        @media (max-width: 768px) {
            .keywords-summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .top-words-grid {
                grid-template-columns: 1fr;
            }
            
            .keyword-tags {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .preview-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                width: 100%;
            }
            
            .control-select {
                min-width: unset;
                width: 100%;
            }
            
            .control-buttons {
                justify-content: center;
                margin-top: 10px;
            }
            
            .file-tabs {
                flex-wrap: wrap;
            }
            
            .file-tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Excelæ™ºèƒ½åˆ†æç³»ç»Ÿ</h1>
            <p>åŸºäºAIçš„Excelæ•°æ®åˆ†æå’Œæ™ºèƒ½é—®ç­”ç³»ç»Ÿ</p>
            
            <div class="system-status" id="systemStatus">
                <div class="status-item">ğŸ”„ æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</div>
            </div>
        </div>

        <div id="mockModeBanner" class="mock-mode-banner" style="display: none;">
            âš ï¸ ç³»ç»Ÿè¿è¡Œåœ¨æ¼”ç¤ºæ¨¡å¼ä¸‹ - åˆ†æç»“æœä¸ºæ¨¡æ‹Ÿæ•°æ®ï¼Œä»…ç”¨äºç•Œé¢æ¼”ç¤º
        </div>

        <div class="main-content">
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-zone">
                    <div class="upload-icon">ğŸ“</div>
                    <h3>ä¸Šä¼ Excelæ–‡ä»¶</h3>
                    <p>æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ï¼ˆæ”¯æŒå¤šé€‰ï¼‰</p>
                    <p style="color: #6c757d; font-size: 14px; margin-top: 10px;">
                        æ”¯æŒæ ¼å¼: .xlsx, .xls, .xlsm (æœ€å¤§50MBæ¯ä¸ª)
                    </p>
                </div>
                
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.xlsm" multiple>
                <button class="upload-btn" id="uploadBtn" onclick="document.getElementById('fileInput').click()">
                    é€‰æ‹©æ–‡ä»¶ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
                </button>

                <div class="file-info" id="fileInfo">
                    <h4>ğŸ“‹ æ–‡ä»¶ä¿¡æ¯</h4>
                    <div id="fileDetails"></div>
                </div>

                <div class="workflow-status" id="workflowStatus" style="display: none;">
                    <h4>ğŸ”„ å¤„ç†çŠ¶æ€</h4>
                    <div id="workflowSteps"></div>
                </div>
            </div>

            <!-- ç¤ºä¾‹é—®é¢˜åŒºåŸŸ -->
            <div class="query-section">
                <h3>ğŸ’¡ ç¤ºä¾‹é—®é¢˜</h3>
                <p style="color: #6c757d; margin-bottom: 15px;">ç‚¹å‡»ä¸‹é¢çš„é—®é¢˜å¿«é€Ÿå¼€å§‹å¯¹è¯ï¼š</p>
                <div class="sample-queries">
                    <div class="sample-query" onclick="sendQuickQuestion('è¯·å¸®æˆ‘åˆ†æè¿™ä¸ªè¡¨æ ¼çš„åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯')">
                        ğŸ“ˆ è¯·å¸®æˆ‘åˆ†æè¿™ä¸ªè¡¨æ ¼çš„åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯
                    </div>
                    <div class="sample-query" onclick="sendQuickQuestion('æ‰¾å‡ºæ•°æ®ä¸­çš„å¼‚å¸¸å€¼å’Œç¦»ç¾¤ç‚¹')">
                        ğŸ” æ‰¾å‡ºæ•°æ®ä¸­çš„å¼‚å¸¸å€¼å’Œç¦»ç¾¤ç‚¹
                    </div>
                    <div class="sample-query" onclick="sendQuickQuestion('å„ä¸ªæ•°å€¼åˆ—ä¹‹é—´æœ‰ä»€ä¹ˆå…³è”å…³ç³»ï¼Ÿ')">
                        ğŸ”— å„ä¸ªæ•°å€¼åˆ—ä¹‹é—´æœ‰ä»€ä¹ˆå…³è”å…³ç³»ï¼Ÿ
                    </div>
                    <div class="sample-query" onclick="sendQuickQuestion('ç”Ÿæˆä¸€ä¸ªæ•°æ®å¯è§†åŒ–å›¾è¡¨')">
                        ğŸ“Š ç”Ÿæˆä¸€ä¸ªæ•°æ®å¯è§†åŒ–å›¾è¡¨
                    </div>
                </div>
            </div>
        </div>

        <!-- æ™ºèƒ½é—®ç­”å¯¹è¯åŒºåŸŸ -->
        <div class="chat-container" id="chatContainer">
            <div class="chat-disabled-overlay" id="chatDisabledOverlay">
                <div style="text-align: center; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“</div>
                    <h3>è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶</h3>
                    <p>ä¸Šä¼ å¹¶å¤„ç†å®ŒExcelæ–‡ä»¶åå³å¯å¼€å§‹æ™ºèƒ½é—®ç­”</p>
                </div>
            </div>
            
            <div class="chat-header">
                <div class="message-avatar" style="background: #2196F3; color: white;">ğŸ¤–</div>
                <div>
                    <h3 style="margin: 0; color: #333;">ğŸ’¬ Excelæ™ºèƒ½åŠ©æ‰‹</h3>
                    <p style="margin: 0; font-size: 14px; color: #666;">åŸºäºAIçš„æ•°æ®åˆ†æé—®ç­”ç³»ç»Ÿ</p>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="welcome-message" id="welcomeMessage">
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ‘‹</div>
                    <h3>æ¬¢è¿ä½¿ç”¨Excelæ™ºèƒ½åŠ©æ‰‹</h3>
                    <p>æˆ‘å¯ä»¥å¸®æ‚¨ï¼š</p>
                    <ul style="text-align: left; display: inline-block; margin-top: 15px;">
                        <li>ğŸ“Š åˆ†ææ•°æ®ç»Ÿè®¡ä¿¡æ¯</li>
                        <li>ğŸ” æ£€æµ‹å¼‚å¸¸å€¼å’Œç¦»ç¾¤ç‚¹</li>
                        <li>ğŸ“ˆ åˆ†ææ•°æ®è¶‹åŠ¿å’Œå…³è”æ€§</li>
                        <li>ğŸ“‹ æä¾›æ•°æ®æ¸…æ´—å»ºè®®</li>
                        <li>ğŸ¨ ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨</li>
                    </ul>
                    <p style="margin-top: 20px;">è¯·å…ˆä¸Šä¼ Excelæ–‡ä»¶ï¼Œç„¶åå¼€å§‹å¯¹è¯å§ï¼</p>
                </div>
                
                <div class="thinking-indicator" id="thinkingIndicator">
                    <div class="message-avatar" style="background: #2196F3; color: white;">ğŸ¤–</div>
                    <div>æ­£åœ¨åˆ†æä¸­</div>
                    <div class="thinking-dots">
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                    </div>
                </div>
                
                <!-- Real-time Progress Indicator -->
                <div class="progress-indicator" id="progressIndicator">
                    <button class="progress-toggle-btn" id="progressToggleBtn" onclick="toggleProgressDetails()" style="display: none;">
                        â–¼
                    </button>
                    
                    <div class="progress-header">
                        <div class="progress-avatar">ğŸ¤–</div>
                        <div class="progress-title">
                            <h4 id="progressTitle">æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚...</h4>
                            <p id="progressMessage">åˆå§‹åŒ–ä¸­...</p>
                        </div>
                        <div class="progress-percentage" id="progressPercentage">0%</div>
                    </div>
                    
                    <div class="progress-bar-container" id="progressBarContainer">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    
                    <div class="progress-steps" id="progressSteps">
                        <!-- Progress steps will be dynamically populated -->
                    </div>
                </div>
            </div>
            
            <div class="chat-input-area">
                <textarea 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
                    disabled
                    onkeydown="handleChatKeyDown(event)"
                ></textarea>
                <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()" disabled>
                    â¤
                </button>
            </div>
        </div>
        
        <!-- æ•°æ®é¢„è§ˆå’Œä»£ç ç”ŸæˆåŒºåŸŸ -->
        <div class="response-section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('data')">ğŸ“Š æ•°æ®é¢„è§ˆ</button>
                <button class="tab" onclick="switchTab('keywords')">ğŸ”¤ å…³é”®è¯åˆ†æ</button>
                <button class="tab" onclick="switchTab('code')">ğŸ’» ç”Ÿæˆä»£ç </button>
            </div>

            <div id="dataTab" class="tab-content active">
                <!-- æ–‡ä»¶é€‰æ‹©æ ‡ç­¾é¡µï¼ˆæ”¯æŒå¤šæ–‡ä»¶æ—¶æ˜¾ç¤ºï¼‰ -->
                <div id="fileTabs" class="file-tabs" style="display: none;">
                    <!-- åŠ¨æ€ç”Ÿæˆæ–‡ä»¶æ ‡ç­¾é¡µ -->
                </div>
                
                <!-- é¢„è§ˆæ§åˆ¶å™¨ -->
                <div id="previewControls" class="preview-controls" style="display: none;">
                    <div class="control-group">
                        <label class="control-label">å·¥ä½œè¡¨:</label>
                        <select id="sheetSelect" class="control-select">
                            <option value="">é€‰æ‹©å·¥ä½œè¡¨...</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">æ˜¾ç¤ºè¡Œæ•°:</label>
                        <select id="rowLimitSelect" class="control-select">
                            <option value="50">50 è¡Œ</option>
                            <option value="100">100 è¡Œ</option>
                            <option value="200">200 è¡Œ</option>
                            <option value="500">500 è¡Œ</option>
                            <option value="1000">1000 è¡Œ</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label class="control-label">æ˜¾ç¤ºåˆ—æ•°:</label>
                        <select id="colLimitSelect" class="control-select">
                            <option value="10">10 åˆ—</option>
                            <option value="20">20 åˆ—</option>
                            <option value="50">50 åˆ—</option>
                            <option value="100">æ‰€æœ‰åˆ—</option>
                        </select>
                    </div>
                    
                    <div class="control-buttons">
                        <button id="refreshPreviewBtn" class="control-btn" onclick="refreshCurrentPreview()">
                            ğŸ”„ åˆ·æ–°
                        </button>
                        <button id="fullPreviewBtn" class="control-btn secondary" onclick="openFullPreview()">
                            ğŸ” å®Œæ•´é¢„è§ˆ
                        </button>
                    </div>
                </div>
                
                <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                <div id="previewLoading" class="preview-loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è½½æ•°æ®é¢„è§ˆ...</p>
                </div>
                
                <!-- æ•°æ®é¢„è§ˆå†…å®¹ -->
                <div id="dataPreview">
                    <p style="text-align: center; color: #666; padding: 40px;">ä¸Šä¼ æ–‡ä»¶åå°†æ˜¾ç¤ºæ•°æ®é¢„è§ˆ...</p>
                </div>
            </div>

            <div id="keywordsTab" class="tab-content">
                <div id="keywordsAnalysis">
                    <p style="text-align: center; color: #666; padding: 40px;">ä¸Šä¼ æ–‡ä»¶åå°†æ˜¾ç¤ºå…³é”®è¯åˆ†æ...</p>
                </div>
            </div>

            <div id="codeTab" class="tab-content">
                <div id="generatedCode">
                    <p style="text-align: center; color: #666; padding: 40px;">åˆ†æå®Œæˆåå°†æ˜¾ç¤ºç”Ÿæˆçš„Pythonä»£ç ...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFile = null;
        let currentFileId = null;
        let systemStatus = null;
        let mockMode = false;
        let chatHistory = [];
        let uploadedFiles = [];
        let fileInfoCache = {};
        let currentFileIndex = 0;
        let currentSheetName = null;
        let availableSheets = [];

        // API base URL
        const API_BASE = '/api';

        // Initialize system
        document.addEventListener('DOMContentLoaded', () => {
            checkSystemStatus();
            initializeChat();
            initializePreviewControls();
        });
        
        // Initialize chat interface
        function initializeChat() {
            const chatDisabledOverlay = document.getElementById('chatDisabledOverlay');
            chatDisabledOverlay.classList.add('show');
        }

        // Check system status
        async function checkSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                systemStatus = await response.json();
                
                updateSystemStatus();
                
                if (!systemStatus.agent_available) {
                    mockMode = true;
                    document.getElementById('mockModeBanner').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Failed to check system status:', error);
                console.warn('æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨');
            }
        }

        function updateSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            
            let statusItems = [];
            
            statusItems.push(`<span class="${systemStatus.agent_available ? 'status-ok' : 'status-warning'}">
                ${systemStatus.agent_available ? 'âœ…' : 'âš ï¸'} Agentç³»ç»Ÿ: ${systemStatus.agent_available ? 'æ­£å¸¸' : 'æ¼”ç¤ºæ¨¡å¼'}
            </span>`);
            
            statusItems.push(`<span class="${systemStatus.mcp_initialized ? 'status-ok' : 'status-warning'}">
                ${systemStatus.mcp_initialized ? 'âœ…' : 'âš ï¸'} MCP: ${systemStatus.mcp_initialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}
            </span>`);
            
            statusItems.push(`<span class="${systemStatus.orchestrator_ready ? 'status-ok' : 'status-warning'}">
                ${systemStatus.orchestrator_ready ? 'âœ…' : 'âš ï¸'} åè°ƒå™¨: ${systemStatus.orchestrator_ready ? 'å°±ç»ª' : 'æœªå°±ç»ª'}
            </span>`);
            
            statusDiv.innerHTML = statusItems.join('');
        }

        // File upload handling
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileDetails = document.getElementById('fileDetails');
        const queryInput = document.getElementById('queryInput');
        const queryBtn = document.getElementById('queryBtn');
        const uploadBtn = document.getElementById('uploadBtn');

        // Drag and drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFiles(Array.from(files));
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFiles(Array.from(e.target.files));
            }
        });

        async function handleFiles(files) {
            // Validate files
            const allowedTypes = ['.xlsx', '.xls', '.xlsm'];
            const validFiles = [];
            
            for (const file of files) {
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                
                if (!allowedTypes.includes(fileExtension)) {
                    console.warn(`æ–‡ä»¶ ${file.name} ä¸æ˜¯Excelæ–‡ä»¶ï¼Œå·²è·³è¿‡`);
                    continue;
                }

                if (file.size > 50 * 1024 * 1024) {
                    console.warn(`æ–‡ä»¶ ${file.name} å¤§å°è¶…è¿‡50MBï¼Œå·²è·³è¿‡`);
                    continue;
                }
                
                validFiles.push(file);
            }
            
            if (validFiles.length === 0) {
                console.error('æ²¡æœ‰æœ‰æ•ˆçš„Excelæ–‡ä»¶');
                return;
            }

            // Store all valid files
            uploadedFiles = validFiles;
            uploadedFile = validFiles[0]; // For compatibility with existing single file logic
            displayFilesInfo(validFiles);
            await uploadFiles(validFiles);
        }

        async function handleFile(file) {
            // Legacy function for single file - now calls handleFiles
            await handleFiles([file]);
        }

        function displayFilesInfo(files) {
            if (files.length === 1) {
                // Single file display
                const file = files[0];
                const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
                fileDetails.innerHTML = `
                    <p><strong>æ–‡ä»¶å:</strong> ${file.name}</p>
                    <p><strong>å¤§å°:</strong> ${sizeInMB} MB</p>
                    <p><strong>ç±»å‹:</strong> ${file.type}</p>
                    <p><strong>æœ€åä¿®æ”¹:</strong> ${new Date(file.lastModified).toLocaleString()}</p>
                `;
            } else {
                // Multiple files display
                const totalSize = files.reduce((sum, file) => sum + file.size, 0);
                const totalSizeInMB = (totalSize / 1024 / 1024).toFixed(2);
                
                let filesListHtml = '';
                files.forEach((file, index) => {
                    const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
                    filesListHtml += `
                        <p><strong>${index + 1}. ${file.name}</strong> (${sizeInMB} MB)</p>
                    `;
                });
                
                fileDetails.innerHTML = `
                    <p><strong>å·²é€‰æ‹©:</strong> ${files.length} ä¸ªæ–‡ä»¶</p>
                    <p><strong>æ€»å¤§å°:</strong> ${totalSizeInMB} MB</p>
                    <hr style="margin: 10px 0;">
                    ${filesListHtml}
                `;
            }
            fileInfo.classList.add('show');
        }

        function displayFileInfo(file) {
            // Legacy function for single file - now calls displayFilesInfo
            displayFilesInfo([file]);
        }

        async function uploadFiles(files) {
            const workflowStatus = document.getElementById('workflowStatus');
            const workflowSteps = document.getElementById('workflowSteps');
            
            uploadBtn.disabled = true;
            workflowStatus.style.display = 'block';
            
            const steps = [
                { id: 'upload', name: files.length === 1 ? 'ğŸ“¤ æ–‡ä»¶ä¸Šä¼ ' : `ğŸ“¤ æ‰¹é‡ä¸Šä¼  (${files.length} ä¸ªæ–‡ä»¶)` },
                { id: 'ingest', name: 'ğŸ“Š æ–‡ä»¶è§£æ' },
                { id: 'profile', name: 'ğŸ” æ•°æ®åˆ†æ' },
                { id: 'ready', name: 'âœ… å‡†å¤‡å°±ç»ª' }
            ];

            workflowSteps.innerHTML = steps.map(step => 
                `<div class="workflow-step">
                    <div class="step-status step-pending" id="status-${step.id}"></div>
                    <span>${step.name}</span>
                </div>`
            ).join('');

            try {
                // Upload files
                setStepStatus('upload', 'running');
                const formData = new FormData();
                
                if (files.length === 1) {
                    // Single file upload (existing API)
                    formData.append('file', files[0]);
                    
                    const uploadResponse = await fetch(`${API_BASE}/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        const error = await uploadResponse.json();
                        throw new Error(error.error || 'Upload failed');
                    }

                    const uploadResult = await uploadResponse.json();
                    currentFileId = uploadResult.file_id;
                } else {
                    // Multiple files upload (batch API if available, fallback to single)
                    files.forEach(file => {
                        formData.append('files', file);
                    });
                    
                    // Try batch upload first
                    let uploadResponse = await fetch(`${API_BASE}/upload/batch`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        // Fallback to single file upload for first file
                        console.warn('Batch upload not available, using single file upload');
                        const singleFormData = new FormData();
                        singleFormData.append('file', files[0]);
                        
                        uploadResponse = await fetch(`${API_BASE}/upload`, {
                            method: 'POST',
                            body: singleFormData
                        });
                        
                        if (!uploadResponse.ok) {
                            const error = await uploadResponse.json();
                            throw new Error(error.error || 'Upload failed');
                        }
                        
                        const uploadResult = await uploadResponse.json();
                        currentFileId = uploadResult.file_id;
                        
                        console.warn(`æ³¨æ„ï¼šç³»ç»Ÿç›®å‰åªæ”¯æŒå•æ–‡ä»¶å¤„ç†ï¼Œå·²ä¸Šä¼ ç¬¬ä¸€ä¸ªæ–‡ä»¶: ${files[0].name}`);
                    } else {
                        const uploadResult = await uploadResponse.json();
                        currentFileId = uploadResult.file_id || uploadResult.file_ids?.[0];
                    }
                }
                
                setStepStatus('upload', 'completed');

                // Process file
                setStepStatus('ingest', 'running');
                const processResponse = await fetch(`${API_BASE}/process/${currentFileId}`, {
                    method: 'POST'
                });

                if (!processResponse.ok) {
                    const error = await processResponse.json();
                    throw new Error(error.error || 'Processing failed');
                }

                const processResult = await processResponse.json();
                setStepStatus('ingest', 'completed');
                setStepStatus('profile', 'running');
                
                // Simulate processing steps
                await new Promise(resolve => setTimeout(resolve, 1500));
                setStepStatus('profile', 'completed');
                setStepStatus('ready', 'running');
                await new Promise(resolve => setTimeout(resolve, 500));
                setStepStatus('ready', 'completed');

                // Enable chat interface
                enableChatInterface();
                
                const successMessage = files.length === 1 
                    ? 'æ–‡ä»¶å¤„ç†å®Œæˆï¼ç°åœ¨å¯ä»¥å¼€å§‹æé—®äº†ã€‚'
                    : `${files.length} ä¸ªæ–‡ä»¶å·²ä¸Šä¼ ï¼Œå½“å‰å¤„ç†æ–‡ä»¶: ${files[0].name}`;
                
                if (processResult.mock_mode) {
                    console.warn(successMessage + ' ç³»ç»Ÿè¿è¡Œåœ¨æ¼”ç¤ºæ¨¡å¼ä¸‹ï¼Œåˆ†æç»“æœä¸ºæ¨¡æ‹Ÿæ•°æ®ã€‚');
                } else {
                    console.log(successMessage);
                }
                
                // Display data preview using backend HTML conversion
                await loadDataPreview();
                
                // Load keywords analysis
                await loadKeywordsAnalysis();
                
            } catch (error) {
                console.error('æ–‡ä»¶å¤„ç†å¤±è´¥: ' + error.message);
                setStepStatus('upload', 'error');
            } finally {
                uploadBtn.disabled = false;
            }
        }

        async function uploadFile(file) {
            // Legacy function for single file - now calls uploadFiles
            await uploadFiles([file]);
        }

        function setStepStatus(stepId, status) {
            const element = document.getElementById(`status-${stepId}`);
            if (element) {
                element.className = `step-status step-${status}`;
            }
        }

        async function loadDataPreview() {
            if (!currentFileId) {
                return;
            }

            try {
                // Show preview controls
                document.getElementById('previewControls').style.display = 'flex';
                
                // Load file sheets information
                await loadFileSheets(currentFileId);
                
                // Show file tabs if multiple files
                if (uploadedFiles.length > 1) {
                    setupFileTabs();
                }
                
                // Load initial preview
                await refreshCurrentPreview();
                
            } catch (error) {
                console.error('Preview error:', error);
                const dataPreview = document.getElementById('dataPreview');
                dataPreview.innerHTML = `<div class="error">æ— æ³•åŠ è½½æ•°æ®é¢„è§ˆ: ${error.message}</div>`;
            }
        }

        async function loadFileSheets(fileId) {
            try {
                const response = await fetch(`${API_BASE}/preview/${fileId}/sheets`);
                
                if (!response.ok) {
                    throw new Error(`Failed to load sheets: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    // The API returns result.info.sheets, not result.sheets
                    availableSheets = (result.info && result.info.sheets) || [];
                    console.log(`Loaded ${availableSheets.length} sheets:`, availableSheets.map(s => s.name));
                    setupSheetSelector();
                    
                    // Cache file info
                    fileInfoCache[fileId] = {
                        sheets: availableSheets,
                        filename: uploadedFiles.find((_, index) => index === currentFileIndex)?.name || 'æœªçŸ¥æ–‡ä»¶'
                    };
                } else {
                    console.error('Sheets API failed:', result.error);
                    throw new Error(result.error || 'Failed to get sheet info');
                }
            } catch (error) {
                console.error('Error loading sheets:', error);
                
                // Fallback: try to get sheet info from initial preview API
                await loadSheetsFromPreview(fileId);
            }
        }

        async function loadSheetsFromPreview(fileId) {
            try {
                const response = await fetch(`${API_BASE}/preview/${fileId}?max_rows=1&max_cols=1`);
                
                if (!response.ok) {
                    throw new Error('Preview API failed');
                }

                const result = await response.json();
                
                if (result.success && result.metadata) {
                    const metadata = result.metadata;
                    
                    // Construct sheets array from metadata
                    availableSheets = [];
                    
                    if (metadata.sheet_names && Array.isArray(metadata.sheet_names)) {
                        availableSheets = metadata.sheet_names.map(name => ({
                            name: name,
                            rows: name === metadata.current_sheet ? metadata.total_rows : 'Unknown'
                        }));
                    } else if (metadata.current_sheet) {
                        // At least we have the current sheet
                        availableSheets = [{
                            name: metadata.current_sheet,
                            rows: metadata.total_rows || 'Unknown'
                        }];
                    }
                    
                    console.log(`Fallback loaded ${availableSheets.length} sheets:`, availableSheets.map(s => s.name));
                    setupSheetSelector();
                } else {
                    console.warn('No sheet info available from either API');
                    availableSheets = [];
                    setupSheetSelector();
                }
            } catch (error) {
                console.error('Fallback sheet loading failed:', error);
                availableSheets = [];
                setupSheetSelector();
            }
        }

        function setupSheetSelector() {
            const sheetSelect = document.getElementById('sheetSelect');
            
            if (!sheetSelect) {
                console.error('Sheet select element not found!');
                return;
            }
            
            sheetSelect.innerHTML = '<option value="">é€‰æ‹©å·¥ä½œè¡¨...</option>';
            
            if (!availableSheets || availableSheets.length === 0) {
                console.warn('No sheets available to display');
                sheetSelect.innerHTML = '<option value="">æš‚æ— å·¥ä½œè¡¨æ•°æ®</option>';
                sheetSelect.disabled = true;
                return;
            }
            
            sheetSelect.disabled = false;
            
            availableSheets.forEach(sheet => {
                const option = document.createElement('option');
                option.value = sheet.name;
                option.textContent = `${sheet.name} (${sheet.rows || 'æœªçŸ¥'} è¡Œ)`;
                sheetSelect.appendChild(option);
            });
            
            // Auto-select first sheet if available
            if (availableSheets.length > 0) {
                currentSheetName = availableSheets[0].name;
                sheetSelect.value = currentSheetName;
                console.log(`Sheet selector initialized with ${availableSheets.length} sheets, selected: ${currentSheetName}`);
            }
            
            // Add event listener for sheet change
            sheetSelect.onchange = function() {
                currentSheetName = this.value;
                console.log('Switching to sheet:', currentSheetName);
                refreshCurrentPreview();
            };
        }

        function setupFileTabs() {
            const fileTabs = document.getElementById('fileTabs');
            fileTabs.style.display = 'flex';
            fileTabs.innerHTML = '';
            
            uploadedFiles.forEach((file, index) => {
                const tab = document.createElement('button');
                tab.className = `file-tab ${index === currentFileIndex ? 'active' : ''}`;
                tab.textContent = file.name;
                tab.onclick = () => switchToFile(index);
                fileTabs.appendChild(tab);
            });
        }

        async function switchToFile(fileIndex) {
            if (fileIndex === currentFileIndex || fileIndex >= uploadedFiles.length) {
                return;
            }
            
            currentFileIndex = fileIndex;
            uploadedFile = uploadedFiles[fileIndex];
            
            // Update active tab
            const tabs = document.querySelectorAll('.file-tab');
            tabs.forEach((tab, index) => {
                tab.classList.toggle('active', index === fileIndex);
            });
            
            // For now, we'll use the same fileId for all files (current limitation)
            // In a full implementation, each file would have its own fileId
            await loadFileSheets(currentFileId);
            await refreshCurrentPreview();
        }

        async function refreshCurrentPreview() {
            if (!currentFileId) {
                return;
            }

            const previewLoading = document.getElementById('previewLoading');
            const dataPreview = document.getElementById('dataPreview');
            
            previewLoading.classList.add('show');
            dataPreview.style.display = 'none';

            try {
                const rowLimit = document.getElementById('rowLimitSelect').value;
                const colLimit = document.getElementById('colLimitSelect').value;
                
                let url = `${API_BASE}/preview/${currentFileId}?max_rows=${rowLimit}&max_cols=${colLimit}`;
                if (currentSheetName) {
                    url += `&sheet=${encodeURIComponent(currentSheetName)}`;
                }

                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Failed to load preview');
                }

                const result = await response.json();
                
                previewLoading.classList.remove('show');
                dataPreview.style.display = 'block';
                
                if (result.success) {
                    displayAdvancedDataPreview(result.html, result.metadata);
                } else {
                    dataPreview.innerHTML = `<div class="error">é¢„è§ˆå¤±è´¥: ${result.error}</div>`;
                }
            } catch (error) {
                console.error('Preview error:', error);
                previewLoading.classList.remove('show');
                dataPreview.style.display = 'block';
                showPreviewError(error, 'é¢„è§ˆåŠ è½½');
            }
        }

        function displayAdvancedDataPreview(htmlContent, metadata) {
            const dataPreview = document.getElementById('dataPreview');
            
            const fileName = uploadedFile ? uploadedFile.name : 'æœªçŸ¥æ–‡ä»¶';
            const sheetName = currentSheetName || (metadata ? metadata.current_sheet : '');
            
            let previewHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <h4>ğŸ“Š æ•°æ®é¢„è§ˆ</h4>
                            <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 13px;">
                                ğŸ“ ${fileName}${sheetName ? ` â†’ ${sheetName}` : ''}
                            </p>
                        </div>
                    </div>
                    
                    <div style="overflow: auto; max-height: 600px; border: 1px solid #ddd; border-radius: 5px;">
                        ${htmlContent}
                    </div>
            `;
            
            if (metadata) {
                const rowLimit = document.getElementById('rowLimitSelect').value;
                const colLimit = document.getElementById('colLimitSelect').value;
                
                previewHTML += `
                    <div class="preview-info">
                        <strong>ğŸ“ˆ æ•°æ®æ¦‚è§ˆ:</strong><br>
                        â€¢ å½“å‰å·¥ä½œè¡¨: ${metadata.current_sheet || sheetName || 'N/A'}<br>
                        â€¢ æ€»è¡Œæ•°: ${metadata.total_rows || 'N/A'} è¡Œ<br>
                        â€¢ æ€»åˆ—æ•°: ${metadata.total_cols || 'N/A'} åˆ—<br>
                        â€¢ æ˜¾ç¤ºèŒƒå›´: ${rowLimit} è¡Œ Ã— ${colLimit === '100' ? 'æ‰€æœ‰' : colLimit} åˆ—<br>
                        ${metadata.truncated && (metadata.truncated.rows || metadata.truncated.cols) ? 
                            'â€¢ âš ï¸ æ˜¾ç¤ºéƒ¨åˆ†æ•°æ®ï¼Œå¯è°ƒæ•´æ˜¾ç¤ºèŒƒå›´æˆ–æŸ¥çœ‹å®Œæ•´é¢„è§ˆ' : 
                            'â€¢ âœ… æ˜¾ç¤ºå®Œæ•´æ•°æ®'}
                    </div>
                `;
            }
            
            // Add tips for first-time users or when there are multiple sheets/files
            if (availableSheets.length > 1 || uploadedFiles.length > 1) {
                previewHTML += showPreviewTips();
            }
            
            previewHTML += '</div>';
            
            dataPreview.innerHTML = previewHTML;
        }

        // Add event listeners for row/col limit changes
        function initializePreviewControls() {
            const rowLimitSelect = document.getElementById('rowLimitSelect');
            const colLimitSelect = document.getElementById('colLimitSelect');
            
            rowLimitSelect.onchange = refreshCurrentPreview;
            colLimitSelect.onchange = refreshCurrentPreview;
        }

        // Add keyboard shortcuts for data preview
        document.addEventListener('keydown', (e) => {
            // Only activate shortcuts when data preview tab is active
            if (!document.getElementById('dataTab').classList.contains('active')) {
                return;
            }
            
            // Ctrl+R or F5: Refresh preview
            if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
                e.preventDefault();
                refreshCurrentPreview();
            }
            
            // Ctrl+F: Open full preview
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                openFullPreview();
            }
        });

        // Enhanced error handling for preview functions
        function showPreviewError(error, context = '') {
            const dataPreview = document.getElementById('dataPreview');
            const errorMessage = typeof error === 'string' ? error : error.message || 'æœªçŸ¥é”™è¯¯';
            
            dataPreview.innerHTML = `
                <div style="background: white; padding: 40px; text-align: center; border-radius: 8px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
                    <h3 style="color: #dc3545; margin-bottom: 15px;">æ•°æ®é¢„è§ˆå¤±è´¥</h3>
                    <p style="color: #6c757d; margin-bottom: 20px;">
                        ${context && `${context}: `}${errorMessage}
                    </p>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="refreshCurrentPreview()" class="control-btn">
                            ğŸ”„ é‡æ–°åŠ è½½
                        </button>
                        <button onclick="loadDataPreview()" class="control-btn secondary">
                            ğŸ”§ é‡ç½®é¢„è§ˆ
                        </button>
                    </div>
                </div>
            `;
        }

        // Add preview hints and tips
        function showPreviewTips() {
            return `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-top: 10px; font-size: 13px;">
                    <strong>ğŸ’¡ é¢„è§ˆæç¤º:</strong><br>
                    â€¢ ä½¿ç”¨å·¥ä½œè¡¨ä¸‹æ‹‰èœå•åˆ‡æ¢ä¸åŒçš„å·¥ä½œè¡¨<br>
                    â€¢ è°ƒæ•´æ˜¾ç¤ºè¡Œæ•°å’Œåˆ—æ•°æ¥æ§åˆ¶é¢„è§ˆèŒƒå›´<br>
                    â€¢ ç‚¹å‡»"å®Œæ•´é¢„è§ˆ"æŸ¥çœ‹æ›´å¤šæ•°æ®<br>
                    â€¢ å¿«æ·é”®: Ctrl+R åˆ·æ–°, Ctrl+F å®Œæ•´é¢„è§ˆ
                </div>
            `;
        }

        // Enhanced file information display
        function getFileInfoSummary() {
            if (!uploadedFiles || uploadedFiles.length === 0) {
                return '';
            }
            
            if (uploadedFiles.length === 1) {
                const file = uploadedFiles[0];
                const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
                return `ğŸ“ ${file.name} (${sizeInMB} MB)`;
            } else {
                const totalSize = uploadedFiles.reduce((sum, file) => sum + file.size, 0);
                const totalSizeInMB = (totalSize / 1024 / 1024).toFixed(2);
                return `ğŸ“ ${uploadedFiles.length} ä¸ªæ–‡ä»¶ (æ€»è®¡ ${totalSizeInMB} MB)`;
            }
        }

        async function openFullPreview() {
            if (!currentFileId) {
                return;
            }
            
            try {
                let url = `${API_BASE}/preview/${currentFileId}?max_rows=1000&max_cols=100`;
                if (currentSheetName) {
                    url += `&sheet=${encodeURIComponent(currentSheetName)}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    // Open in new window/tab with full preview
                    const newWindow = window.open('', '_blank');
                    const fileName = uploadedFile ? uploadedFile.name : 'æ•°æ®';
                    const sheetName = currentSheetName || '';
                    
                    newWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>å®Œæ•´æ•°æ®é¢„è§ˆ - ${fileName}${sheetName ? ` â†’ ${sheetName}` : ''}</title>
                            <meta charset="UTF-8">
                            <style>
                                body { font-family: 'Segoe UI', sans-serif; margin: 20px; }
                                .header { text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #ddd; }
                                .info { background: #f8f9fa; padding: 10px; margin-bottom: 15px; border-radius: 5px; }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>ğŸ“Š å®Œæ•´æ•°æ®é¢„è§ˆ</h1>
                                <p>ğŸ“ æ–‡ä»¶: ${fileName}</p>
                                ${sheetName ? `<p>ğŸ“‹ å·¥ä½œè¡¨: ${sheetName}</p>` : ''}
                            </div>
                            ${result.metadata ? `
                                <div class="info">
                                    <strong>æ•°æ®æ¦‚è§ˆ:</strong>
                                    æ€»è¡Œæ•°: ${result.metadata.total_rows || 'N/A'} è¡Œ |
                                    æ€»åˆ—æ•°: ${result.metadata.total_cols || 'N/A'} åˆ—
                                </div>
                            ` : ''}
                            <div style="overflow: auto;">
                                ${result.html}
                            </div>
                        </body>
                        </html>
                    `);
                    newWindow.document.close();
                } else {
                    console.error('æ— æ³•åŠ è½½å®Œæ•´é¢„è§ˆ: ' + result.error);
                }
            } catch (error) {
                console.error('Error opening full preview:', error);
            }
        }


        // Enable chat interface
        function enableChatInterface() {
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const chatDisabledOverlay = document.getElementById('chatDisabledOverlay');
            const welcomeMessage = document.getElementById('welcomeMessage');
            
            chatInput.disabled = false;
            chatSendBtn.disabled = false;
            chatDisabledOverlay.classList.remove('show');
            
            // Hide welcome message and add initial assistant message
            welcomeMessage.style.display = 'none';
            
            addChatMessage('assistant', 'æ‚¨å¥½ï¼æˆ‘æ˜¯Excelæ™ºèƒ½åŠ©æ‰‹ã€‚æ–‡ä»¶å·²ç»å¤„ç†å®Œæˆï¼Œç°åœ¨æ‚¨å¯ä»¥é—®æˆ‘ä»»ä½•å…³äºæ•°æ®çš„é—®é¢˜ã€‚æˆ‘å¯ä»¥å¸®æ‚¨åˆ†ææ•°æ®ã€æŸ¥æ‰¾æ¨¡å¼ã€ç”Ÿæˆå›¾è¡¨ç­‰ã€‚è¯·è¾“å…¥æ‚¨æƒ³äº†è§£çš„é—®é¢˜å§ï¼');
        }
        
        // Add message to chat
        function addChatMessage(sender, content, timestamp = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = timestamp || new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            let avatarIcon = 'ğŸ¤–';
            if (sender === 'user') {
                avatarIcon = 'ğŸ‘¤';
            } else if (sender === 'system') {
                avatarIcon = 'âš™ï¸';
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarIcon}</div>
                <div>
                    <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
                    <div class="message-time">${timeStr}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Store in chat history
            chatHistory.push({
                sender: sender,
                content: content,
                timestamp: now
            });
        }
        
        // Handle chat input keydown
        function handleChatKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }
        
        // Send chat message
        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) {
                return;
            }
            
            if (!currentFileId) {
                addChatMessage('assistant', 'æŠ±æ­‰ï¼Œè¯·å…ˆä¸Šä¼ å¹¶å¤„ç†Excelæ–‡ä»¶æ‰èƒ½å¼€å§‹åˆ†æã€‚');
                return;
            }
            
            // Add user message
            addChatMessage('user', message);
            
            // Clear input
            chatInput.value = '';
            
            // Show progress tracking instead of simple thinking indicator
            showProgressIndicator();
            
            // Disable input during processing
            chatInput.disabled = true;
            document.getElementById('chatSendBtn').disabled = true;
            
            let progressEventSource = null;
            try {
                const response = await fetch(`${API_BASE}/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        file_id: currentFileId,
                        query: message
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Query failed');
                }

                const result = await response.json();
                
                // If we got a request_id, connect to progress stream
                if (result.request_id) {
                    connectToProgressStream(result.request_id, message);
                } else {
                    // No request ID - this is a direct response (no progress tracking)
                    hideProgressIndicator();
                    
                    // Add assistant response
                    const assistantResponse = result.user_response || result.response || result.answer || "æŠ±æ­‰ï¼Œæˆ‘æ— æ³•å¤„ç†æ‚¨çš„é—®é¢˜ã€‚";
                    addChatMessage('assistant', assistantResponse);
                    
                    // Display generated code if available
                    if (result.generated_code) {
                        displayGeneratedCode(result.generated_code, message, result.mock_mode);
                    }
                    
                    // Show workflow completion if available
                    if (result.workflow_steps && result.workflow_steps.length > 0) {
                        const successSteps = result.workflow_steps.filter(step => step.status === 'success').length;
                        const totalSteps = result.workflow_steps.length;
                        addChatMessage('system', `ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼æˆåŠŸæ‰§è¡Œäº† ${successSteps}/${totalSteps} ä¸ªæ­¥éª¤ã€‚`);
                    }
                    
                    // Re-enable input
                    chatInput.disabled = false;
                    document.getElementById('chatSendBtn').disabled = false;
                    chatInput.focus();
                }
                
            } catch (error) {
                hideProgressIndicator();
                addChatMessage('assistant', `æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„é—®é¢˜æ—¶å‡ºç°äº†é”™è¯¯ï¼š${error.message}`);
                
                // Re-enable input
                chatInput.disabled = false;
                document.getElementById('chatSendBtn').disabled = false;
                chatInput.focus();
            }
        }
        
        // Send quick question
        function sendQuickQuestion(question) {
            const chatInput = document.getElementById('chatInput');
            if (!currentFileId) {
                return;
            }
            
            chatInput.value = question;
            sendChatMessage();
        }

        // Keywords analysis functions
        async function loadKeywordsAnalysis() {
            if (!currentFileId) {
                return;
            }

            const keywordsAnalysis = document.getElementById('keywordsAnalysis');
            
            try {
                // Show loading state
                keywordsAnalysis.innerHTML = `
                    <div class="keywords-loading show">
                        <div class="spinner"></div>
                        <p>æ­£åœ¨åˆ†æå…³é”®è¯...</p>
                    </div>
                `;

                // Fetch keywords analysis
                const response = await fetch(`${API_BASE}/files/${currentFileId}/keywords`);
                
                if (!response.ok) {
                    throw new Error('Failed to load keywords analysis');
                }

                const result = await response.json();
                
                if (result.success && result.text_analysis) {
                    displayKeywordsAnalysis(result.text_analysis, result.filename);
                } else {
                    // If basic analysis not available, try detailed analysis
                    await loadDetailedKeywordsAnalysis();
                }
                
            } catch (error) {
                console.error('Keywords analysis error:', error);
                
                // Try detailed analysis as fallback
                try {
                    await loadDetailedKeywordsAnalysis();
                } catch (detailError) {
                    console.error('Detailed keywords analysis also failed:', detailError);
                    showKeywordsError(error.message);
                }
            }
        }

        async function loadDetailedKeywordsAnalysis() {
            const response = await fetch(`${API_BASE}/files/${currentFileId}/keywords/detailed`);
            
            if (!response.ok) {
                throw new Error('è¯¦ç»†å…³é”®è¯åˆ†æä¸å¯ç”¨');
            }

            const result = await response.json();
            
            if (result.success && result.detailed_analysis) {
                displayDetailedKeywordsAnalysis(result.detailed_analysis, result.filename);
            } else {
                throw new Error(result.error || 'æ— æ³•è·å–å…³é”®è¯åˆ†æ');
            }
        }

        function displayKeywordsAnalysis(textAnalysis, filename) {
            const keywordsAnalysis = document.getElementById('keywordsAnalysis');
            
            const totalTexts = textAnalysis.total_texts || 0;
            const totalWords = textAnalysis.total_words || 0;
            const uniqueWordCount = textAnalysis.unique_word_count || 0;
            const topWords = textAnalysis.top_words || {};
            const keywordsBySheet = textAnalysis.keywords_by_sheet || {};
            const sheetSummary = textAnalysis.sheet_summary || {};

            let html = `
                <div class="keywords-container">
                    <div class="keywords-header">
                        <div>
                            <h3>ğŸ”¤ å…³é”®è¯åˆ†æ</h3>
                            <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 14px;">
                                ğŸ“ ${filename} - åŸºäºjiebaåˆ†è¯çš„å…³é”®è¯æå–
                            </p>
                        </div>
                        <div class="keywords-controls">
                            <button class="keywords-refresh-btn" onclick="refreshKeywordsAnalysis()">
                                ğŸ”„ åˆ·æ–°åˆ†æ
                            </button>
                        </div>
                    </div>

                    <div class="keywords-summary">
                        <h4 style="margin-bottom: 10px;">ğŸ“Š åˆ†ææ¦‚è§ˆ</h4>
                        <div class="keywords-summary-stats">
                            <div class="stat-item">
                                <div class="stat-number">${totalTexts}</div>
                                <div class="stat-label">æ–‡æœ¬å•å…ƒ</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${totalWords}</div>
                                <div class="stat-label">æ€»è¯æ•°</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${uniqueWordCount}</div>
                                <div class="stat-label">å”¯ä¸€è¯æ±‡</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${Object.keys(sheetSummary).length}</div>
                                <div class="stat-label">å·¥ä½œè¡¨æ•°</div>
                            </div>
                        </div>
                    </div>
            `;

            // é«˜é¢‘è¯æ±‡
            if (Object.keys(topWords).length > 0) {
                html += `
                    <div class="keywords-section">
                        <h4>ğŸ”¥ é«˜é¢‘è¯æ±‡ (Top ${Math.min(20, Object.keys(topWords).length)})</h4>
                        <div class="top-words-grid">
                `;
                
                const sortedTopWords = Object.entries(topWords)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 20);
                
                sortedTopWords.forEach(([word, count]) => {
                    html += `
                        <div class="word-item">
                            <span class="word-text">${word}</span>
                            <span class="word-count">${count}</span>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }

            // æŒ‰å·¥ä½œè¡¨æ˜¾ç¤ºå…³é”®è¯
            if (Object.keys(keywordsBySheet).length > 0) {
                html += `<div class="keywords-section"><h4>ğŸ“‹ å„å·¥ä½œè¡¨å…³é”®è¯</h4>`;
                
                Object.entries(keywordsBySheet).forEach(([sheetName, keywords]) => {
                    const sheetInfo = sheetSummary[sheetName] || {};
                    const textCount = sheetInfo.text_count || 0;
                    const wordCount = sheetInfo.word_count || 0;
                    
                    html += `
                        <div class="sheet-keywords">
                            <div class="sheet-header">
                                <div class="sheet-title">ğŸ“„ ${sheetName}</div>
                                <div class="sheet-stats">
                                    ${textCount} ä¸ªæ–‡æœ¬å•å…ƒ â€¢ ${wordCount} ä¸ªè¯æ±‡
                                </div>
                            </div>
                    `;
                    
                    if (keywords && keywords.length > 0) {
                        html += `
                            <div class="keyword-tags">
                        `;
                        
                        keywords.forEach(keyword => {
                            let word, weight;
                            if (Array.isArray(keyword) && keyword.length >= 2) {
                                [word, weight] = keyword;
                            } else if (typeof keyword === 'string') {
                                word = keyword;
                                weight = 1.0;
                            } else {
                                return;
                            }
                            
                            const weightStr = typeof weight === 'number' ? weight.toFixed(3) : weight;
                            
                            html += `
                                <div class="keyword-tag">
                                    <span>${word}</span>
                                    <span class="keyword-weight">${weightStr}</span>
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    } else {
                        html += `<p style="color: #666; font-style: italic;">è¯¥å·¥ä½œè¡¨æ— å…³é”®è¯æ•°æ®</p>`;
                    }
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            }

            if (Object.keys(topWords).length === 0 && Object.keys(keywordsBySheet).length === 0) {
                html += `
                    <div class="no-keywords">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“</div>
                        <h3>æš‚æ— å…³é”®è¯æ•°æ®</h3>
                        <p>è¯¥Excelæ–‡ä»¶å¯èƒ½ä¸åŒ…å«è¶³å¤Ÿçš„æ–‡æœ¬å†…å®¹è¿›è¡Œå…³é”®è¯åˆ†æï¼Œ</p>
                        <p>æˆ–è€…æ–‡ä»¶å°šæœªè¿›è¡Œæ–‡æœ¬åˆ†æå¤„ç†ã€‚</p>
                        <button class="keywords-refresh-btn" onclick="refreshKeywordsAnalysis()" style="margin-top: 15px;">
                            ğŸ”„ é‡æ–°åˆ†æ
                        </button>
                    </div>
                `;
            }

            html += `</div>`;
            keywordsAnalysis.innerHTML = html;
        }

        function displayDetailedKeywordsAnalysis(detailedAnalysis, filename) {
            // Convert detailed analysis to the same format as basic analysis
            const sheets = detailedAnalysis.sheets || {};
            const totalTexts = detailedAnalysis.total_texts || 0;
            const totalWords = detailedAnalysis.total_words || 0;
            const uniqueWordCount = detailedAnalysis.unique_word_count || 0;

            // Create top words from detailed analysis
            const topWords = {};
            const keywordsBySheet = {};
            const sheetSummary = {};

            Object.entries(sheets).forEach(([sheetName, sheetData]) => {
                // Collect top words for this sheet
                const wordFreq = sheetData.word_frequency || {};
                Object.entries(wordFreq).forEach(([word, count]) => {
                    topWords[word] = (topWords[word] || 0) + count;
                });

                // Collect keywords for this sheet
                keywordsBySheet[sheetName] = sheetData.keywords || [];

                // Sheet summary
                sheetSummary[sheetName] = {
                    text_count: sheetData.text_count || 0,
                    word_count: sheetData.word_count || 0,
                    unique_word_count: sheetData.unique_words ? sheetData.unique_words.length : 0
                };
            });

            // Display using the same function
            displayKeywordsAnalysis({
                total_texts: totalTexts,
                total_words: totalWords,
                unique_word_count: uniqueWordCount,
                top_words: topWords,
                keywords_by_sheet: keywordsBySheet,
                sheet_summary: sheetSummary
            }, filename);
        }

        function showKeywordsError(errorMessage) {
            const keywordsAnalysis = document.getElementById('keywordsAnalysis');
            keywordsAnalysis.innerHTML = `
                <div class="keywords-error">
                    <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
                    <h3>å…³é”®è¯åˆ†æå¤±è´¥</h3>
                    <p>${errorMessage}</p>
                    <button class="keywords-refresh-btn" onclick="refreshKeywordsAnalysis()" style="margin-top: 15px;">
                        ğŸ”„ é‡è¯•
                    </button>
                </div>
            `;
        }

        async function refreshKeywordsAnalysis() {
            await loadKeywordsAnalysis();
        }


        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // Progress tracking functions
        let currentProgressStream = null;
        
        function showProgressIndicator() {
            const progressIndicator = document.getElementById('progressIndicator');
            const thinkingIndicator = document.getElementById('thinkingIndicator');
            
            // Hide old thinking indicator
            thinkingIndicator.classList.remove('show');
            
            // Show progress indicator
            progressIndicator.classList.add('show');
            
            // Reset progress
            updateProgress(0, 'åˆå§‹åŒ–ä¸­...', 'æ­£åœ¨å‡†å¤‡å¤„ç†æ‚¨çš„è¯·æ±‚...');
            
            // Clear steps
            document.getElementById('progressSteps').innerHTML = '';
        }
        
        function hideProgressIndicator() {
            const progressIndicator = document.getElementById('progressIndicator');
            progressIndicator.classList.remove('show');
            progressIndicator.classList.remove('completed');
            progressIndicator.classList.remove('expanded');
            
            // Hide toggle button
            const toggleBtn = document.getElementById('progressToggleBtn');
            toggleBtn.style.display = 'none';
            
            // Show progress bar container
            const progressBarContainer = document.getElementById('progressBarContainer');
            progressBarContainer.style.display = 'block';
            
            // Close any existing progress stream
            if (currentProgressStream) {
                currentProgressStream.close();
                currentProgressStream = null;
            }
        }

        function completeProgressIndicator() {
            const progressIndicator = document.getElementById('progressIndicator');
            const toggleBtn = document.getElementById('progressToggleBtn');
            const progressBarContainer = document.getElementById('progressBarContainer');
            
            // Mark as completed and show toggle button
            progressIndicator.classList.add('completed');
            progressIndicator.classList.add('show'); // Keep visible
            toggleBtn.style.display = 'flex';
            toggleBtn.textContent = 'â–¼';
            toggleBtn.title = 'æ˜¾ç¤ºå¤„ç†æ­¥éª¤è¯¦æƒ…';
            
            // Hide progress bar in completed state
            progressBarContainer.style.display = 'none';
            
            // Close any existing progress stream
            if (currentProgressStream) {
                currentProgressStream.close();
                currentProgressStream = null;
            }
        }

        function toggleProgressDetails() {
            const progressIndicator = document.getElementById('progressIndicator');
            const toggleBtn = document.getElementById('progressToggleBtn');
            
            if (progressIndicator.classList.contains('expanded')) {
                progressIndicator.classList.remove('expanded');
                toggleBtn.textContent = 'â–¼';
                toggleBtn.title = 'æ˜¾ç¤ºå¤„ç†æ­¥éª¤è¯¦æƒ…';
            } else {
                progressIndicator.classList.add('expanded');
                toggleBtn.textContent = 'â–²';
                toggleBtn.title = 'éšè—å¤„ç†æ­¥éª¤è¯¦æƒ…';
            }
        }
        
        function updateProgress(percentage, message, title = null) {
            const progressBar = document.getElementById('progressBar');
            const progressMessage = document.getElementById('progressMessage');
            const progressTitle = document.getElementById('progressTitle');
            const progressPercentage = document.getElementById('progressPercentage');
            
            // Update progress bar
            progressBar.style.width = `${percentage}%`;
            
            // Update text
            progressMessage.textContent = message;
            progressPercentage.textContent = `${percentage}%`;
            
            if (title) {
                progressTitle.textContent = title;
            }
        }
        
        function updateProgressSteps(steps) {
            const progressSteps = document.getElementById('progressSteps');
            
            progressSteps.innerHTML = steps.map(step => {
                const iconContent = getStepIcon(step.status);
                const hasDetails = step.details || step.input || step.output || step.result;
                
                return `
                    <div class="progress-step ${step.status}" data-step-id="${step.step_id}">
                        <div class="progress-step-icon">${iconContent}</div>
                        <div class="progress-step-content">
                            <div class="progress-step-name">
                                ${step.step_name}
                                ${hasDetails ? `<button class="progress-step-expand-btn" onclick="toggleStepDetails('${step.step_id}')">è¯¦æƒ…</button>` : ''}
                            </div>
                            <div class="progress-step-description">${step.description || ''}</div>
                            
                            ${hasDetails ? `
                                <div class="progress-step-details" id="details-${step.step_id}">
                                    ${step.input ? `
                                        <div class="step-input-output">
                                            <strong>ğŸ“¥ è¾“å…¥å‚æ•°:</strong>
                                            <div class="step-data">${formatStepData(step.input)}</div>
                                        </div>
                                    ` : ''}
                                    
                                    ${step.output ? `
                                        <div class="step-input-output">
                                            <strong>ğŸ“¤ è¾“å‡ºç»“æœ:</strong>
                                            <div class="step-data">${formatStepData(step.output)}</div>
                                        </div>
                                    ` : ''}
                                    
                                    ${step.result ? `
                                        <div class="step-input-output">
                                            <strong>ğŸ¯ å¤„ç†ç»“æœ:</strong>
                                            <div class="step-data">${formatStepData(step.result)}</div>
                                        </div>
                                    ` : ''}
                                    
                                    ${step.details ? `
                                        <div class="step-input-output">
                                            <strong>â„¹ï¸ è¯¦ç»†ä¿¡æ¯:</strong>
                                            <div class="step-data">${formatStepData(step.details)}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                        ${step.agent ? `<div class="progress-step-agent">${step.agent}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function formatStepData(data) {
            if (typeof data === 'string') {
                return data.length > 200 ? data.substring(0, 200) + '...\n[æ•°æ®å·²æˆªæ–­]' : data;
            } else if (typeof data === 'object') {
                try {
                    const jsonStr = JSON.stringify(data, null, 2);
                    return jsonStr.length > 500 ? jsonStr.substring(0, 500) + '...\n[JSONæ•°æ®å·²æˆªæ–­]' : jsonStr;
                } catch (e) {
                    return '[æ— æ³•è§£æçš„å¯¹è±¡æ•°æ®]';
                }
            } else {
                return String(data);
            }
        }

        function toggleStepDetails(stepId) {
            const step = document.querySelector(`[data-step-id="${stepId}"]`);
            if (step) {
                if (step.classList.contains('expanded')) {
                    step.classList.remove('expanded');
                } else {
                    step.classList.add('expanded');
                }
            }
        }
        
        function getStepIcon(status) {
            switch (status) {
                case 'pending':
                    return 'â³';
                case 'in_progress':
                case 'in-progress':
                    return 'ğŸ”„';
                case 'completed':
                    return 'âœ…';
                case 'failed':
                    return 'âŒ';
                case 'warning':
                    return 'âš ï¸';
                default:
                    return 'âšª';
            }
        }
        
        function connectToProgressStream(requestId, originalQuery) {
            // Close any existing stream
            if (currentProgressStream) {
                currentProgressStream.close();
            }
            
            const url = `${API_BASE}/progress/${requestId}`;
            console.log(`Connecting to progress stream: ${url}`);
            
            currentProgressStream = new EventSource(url);
            
            currentProgressStream.onopen = function(event) {
                console.log('Progress stream connected');
                updateProgress(0, 'å·²è¿æ¥åˆ°è¿›åº¦æ›´æ–°æµ...', 'æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚...');
            };
            
            currentProgressStream.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Progress update received:', data);
                    
                    if (data.type === 'connected') {
                        updateProgress(0, data.message);
                    } else if (data.type === 'progress') {
                        // Update main progress
                        updateProgress(
                            data.progress_percent,
                            data.message,
                            `æ­£åœ¨æ‰§è¡Œ: ${data.current_step_name}`
                        );
                        
                        // Update steps if available
                        if (data.all_steps && data.all_steps.length > 0) {
                            updateProgressSteps(data.all_steps);
                        }
                        
                        // Check if completed
                        if (data.status === 'completed' && data.progress_percent >= 100) {
                            setTimeout(() => {
                                // Close stream and fetch final result
                                currentProgressStream.close();
                                currentProgressStream = null;
                                
                                // Wait a moment for backend to finish, then get the result
                                setTimeout(() => {
                                    fetchFinalResult(requestId, originalQuery);
                                }, 1000);
                            }, 1000);
                        }
                        
                    } else if (data.type === 'heartbeat') {
                        // Just keep the connection alive, no UI update needed
                        console.log('Heartbeat received');
                    }
                    
                } catch (error) {
                    console.error('Error parsing progress data:', error);
                }
            };
            
            currentProgressStream.onerror = function(event) {
                console.error('Progress stream error:', event);
                currentProgressStream.close();
                currentProgressStream = null;
                
                // Fall back to polling for result
                setTimeout(() => {
                    fetchFinalResult(requestId, originalQuery);
                }, 2000);
            };
            
            // Set up timeout to prevent hanging
            setTimeout(() => {
                if (currentProgressStream && currentProgressStream.readyState === EventSource.OPEN) {
                    console.log('Progress stream timeout, closing connection');
                    currentProgressStream.close();
                    currentProgressStream = null;
                    fetchFinalResult(requestId, originalQuery);
                }
            }, 120000); // 2 minute timeout
        }
        
        async function fetchFinalResult(requestId, originalQuery) {
            try {
                updateProgress(95, 'æ­£åœ¨è·å–æœ€ç»ˆç»“æœ...', 'å‡ ä¹å®Œæˆäº†...');
                
                // First, try to get the stored result from the backend (avoid duplicate API calls)
                const resultResponse = await fetch(`${API_BASE}/progress/${requestId}/result`);
                
                if (resultResponse.ok) {
                    const resultData = await resultResponse.json();
                    if (resultData.success && resultData.result) {
                        const result = resultData.result;
                        console.log('Stored query result:', result);
                        
                        updateProgress(100, 'åˆ†æå®Œæˆï¼', 'æ­£åœ¨ç”Ÿæˆå›ç­”...');
                        
                        // Keep progress display longer so users can see the steps
                        setTimeout(() => {
                            // Extract the actual response content
                            const assistantResponse = result.user_response || result.response || result.answer || "åˆ†æå·²å®Œæˆï¼Œè¯·æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç ã€‚";
                            
                            // Add the actual agent response to chat
                            addChatMessage('assistant', assistantResponse);
                            
                            // Display generated code if available
                            if (result.generated_code) {
                                displayGeneratedCode(result.generated_code, originalQuery, result.mock_mode);
                            }
                            
                            // Show success message for workflow completion
                            if (result.workflow_steps && result.workflow_steps.length > 0) {
                                const successSteps = result.workflow_steps.filter(step => step.status === 'success').length;
                                const totalSteps = result.workflow_steps.length;
                                addChatMessage('system', `ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼æˆåŠŸæ‰§è¡Œäº† ${successSteps}/${totalSteps} ä¸ªæ­¥éª¤ã€‚`);
                            }
                            
                            // Complete progress indicator (keep visible with toggle)
                            setTimeout(() => {
                                completeProgressIndicator();
                                
                                // Re-enable input
                                const chatInput = document.getElementById('chatInput');
                                const chatSendBtn = document.getElementById('chatSendBtn');
                                chatInput.disabled = false;
                                chatSendBtn.disabled = false;
                                chatInput.focus();
                            }, 2000); // Keep progress visible for 2 more seconds
                            
                        }, 3000); // Wait 3 seconds before showing response so users can see progress
                        
                        return;
                    }
                }
                
                // If no stored result available, make a fresh API call (fallback)
                console.log('No stored result found, making fresh query...');
                const queryResponse = await fetch(`${API_BASE}/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        file_id: currentFileId,
                        query: originalQuery
                    })
                });
                
                if (queryResponse.ok) {
                    const result = await queryResponse.json();
                    console.log('Fresh query result:', result);
                    
                    updateProgress(100, 'åˆ†æå®Œæˆï¼', 'æ­£åœ¨ç”Ÿæˆå›ç­”...');
                    
                    // Keep progress display longer
                    setTimeout(() => {
                        const assistantResponse = result.user_response || result.response || result.answer || "åˆ†æå·²å®Œæˆï¼Œä½†æœªç”Ÿæˆå…·ä½“å›ç­”ã€‚";
                        addChatMessage('assistant', assistantResponse);
                        
                        if (result.generated_code) {
                            displayGeneratedCode(result.generated_code, originalQuery, result.mock_mode);
                        }
                        
                        if (result.workflow_steps && result.workflow_steps.length > 0) {
                            const successSteps = result.workflow_steps.filter(step => step.status === 'success').length;
                            const totalSteps = result.workflow_steps.length;
                            addChatMessage('system', `ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼æˆåŠŸæ‰§è¡Œäº† ${successSteps}/${totalSteps} ä¸ªæ­¥éª¤ã€‚`);
                        }
                        
                        setTimeout(() => {
                            completeProgressIndicator();
                            
                            const chatInput = document.getElementById('chatInput');
                            const chatSendBtn = document.getElementById('chatSendBtn');
                            chatInput.disabled = false;
                            chatSendBtn.disabled = false;
                            chatInput.focus();
                        }, 2000);
                        
                    }, 3000);
                    
                    return;
                }
                
                // Fallback: Try to get progress info
                const progressResponse = await fetch(`${API_BASE}/progress/${requestId}/info`);
                
                if (progressResponse.ok) {
                    const progressData = await progressResponse.json();
                    console.log('Final progress data:', progressData);
                    
                    if (progressData.success && progressData.progress.status === 'completed') {
                        updateProgress(100, 'åˆ†æå®Œæˆï¼', 'å·¥ä½œæµå·²å®Œæˆ');
                        
                        // Keep progress visible longer
                        setTimeout(() => {
                            addChatMessage('assistant', 'âœ… æ•°æ®åˆ†æå·²å®Œæˆï¼å·¥ä½œæµæˆåŠŸæ‰§è¡Œäº†æ‰€æœ‰æ­¥éª¤ã€‚');
                            
                            // Show workflow summary
                            const steps = progressData.progress.steps;
                            const completedSteps = steps.filter(step => step.status === 'completed').length;
                            addChatMessage('system', `ğŸ“Š æ‰§è¡Œæ€»ç»“ï¼š${completedSteps}/${steps.length} ä¸ªæ­¥éª¤æˆåŠŸå®Œæˆ`);
                            
                            setTimeout(() => {
                                completeProgressIndicator();
                                
                                // Re-enable input
                                const chatInput = document.getElementById('chatInput');
                                const chatSendBtn = document.getElementById('chatSendBtn');
                                chatInput.disabled = false;
                                chatSendBtn.disabled = false;
                                chatInput.focus();
                            }, 2000);
                        }, 3000);
                        
                        return;
                    }
                }
                
                // If all else fails, show generic completion message
                setTimeout(() => {
                    hideProgressIndicator();
                    addChatMessage('assistant', 'å¤„ç†å®Œæˆï¼Œä½†æ— æ³•è·å–è¯¦ç»†ç»“æœã€‚è¯·é‡è¯•æ‚¨çš„é—®é¢˜ã€‚');
                    
                    // Re-enable input
                    const chatInput = document.getElementById('chatInput');
                    const chatSendBtn = document.getElementById('chatSendBtn');
                    chatInput.disabled = false;
                    chatSendBtn.disabled = false;
                    chatInput.focus();
                }, 2000);
                
            } catch (error) {
                console.error('Error fetching final result:', error);
                setTimeout(() => {
                    hideProgressIndicator();
                    addChatMessage('assistant', `æŠ±æ­‰ï¼Œè·å–æœ€ç»ˆç»“æœæ—¶å‡ºç°é”™è¯¯ï¼š${error.message}`);
                    
                    // Re-enable input
                    const chatInput = document.getElementById('chatInput');
                    const chatSendBtn = document.getElementById('chatSendBtn');
                    chatInput.disabled = false;
                    chatSendBtn.disabled = false;
                    chatInput.focus();
                }, 2000);
            }
        }
        
        function displayGeneratedCode(code, query, mockMode = false) {
            document.getElementById('generatedCode').innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <h4>ğŸ’» ç”Ÿæˆçš„Pythonä»£ç </h4>
                    <div style="color: #666; margin-bottom: 10px; font-size: 14px;">
                        ğŸ“… ${new Date().toLocaleString()} - åŸºäºé—®é¢˜: "${query}"
                    </div>
                    ${mockMode ? '<div style="background: #fff3e0; color: #e65100; padding: 10px; border-radius: 5px; margin-bottom: 10px;">âš ï¸ æ¼”ç¤ºæ¨¡å¼ - ä»£ç ä»…ä¾›å‚è€ƒ</div>' : ''}
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 13px;"><code>${code}</code></pre>
                </div>
            `;
        }

    </script>
</body>
</html>