<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excelæ™ºèƒ½åˆ†æç³»ç»Ÿ - APIç‰ˆæœ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .system-status {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
        }

        .status-item {
            display: inline-block;
            margin: 0 15px;
            font-size: 14px;
        }

        .status-ok { color: #4CAF50; }
        .status-warning { color: #FF9800; }
        .status-error { color: #F44336; }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
            min-height: 600px;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .upload-section.dragover {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .upload-zone {
            text-align: center;
            margin-bottom: 20px;
        }

        .upload-icon {
            font-size: 3em;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .upload-btn:hover {
            background: #45a049;
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .file-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .query-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
        }

        .query-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            resize: vertical;
            min-height: 120px;
        }

        .query-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .query-btn {
            background: #2196F3;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background 0.3s;
        }

        .query-btn:hover {
            background: #1976D2;
        }

        .query-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .response-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-top: 30px;
            min-height: 300px;
        }

        .response-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #4CAF50;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #f44336;
            margin: 10px 0;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
            margin: 10px 0;
        }

        .warning {
            background: #fff3e0;
            color: #ef6c00;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ff9800;
            margin: 10px 0;
        }

        .sample-queries {
            margin-top: 20px;
        }

        .sample-query {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            border: 1px solid #dee2e6;
        }

        .sample-query:hover {
            background: #e3f2fd;
        }

        .workflow-status {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #2196F3;
        }

        .workflow-step {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .step-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .step-pending { background: #ccc; }
        .step-running { background: #ff9800; }
        .step-completed { background: #4caf50; }
        .step-error { background: #f44336; }

        .tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
            color: #6c757d;
            transition: all 0.3s;
        }

        .tab.active {
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .mock-mode-banner {
            background: #fff3e0;
            color: #e65100;
            padding: 10px 20px;
            text-align: center;
            border-left: 4px solid #ff9800;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š Excelæ™ºèƒ½åˆ†æç³»ç»Ÿ</h1>
            <p>åŸºäºAIçš„Excelæ•°æ®åˆ†æå’Œæ™ºèƒ½é—®ç­”ç³»ç»Ÿ</p>
            
            <div class="system-status" id="systemStatus">
                <div class="status-item">ğŸ”„ æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...</div>
            </div>
        </div>

        <div id="mockModeBanner" class="mock-mode-banner" style="display: none;">
            âš ï¸ ç³»ç»Ÿè¿è¡Œåœ¨æ¼”ç¤ºæ¨¡å¼ä¸‹ - åˆ†æç»“æœä¸ºæ¨¡æ‹Ÿæ•°æ®ï¼Œä»…ç”¨äºç•Œé¢æ¼”ç¤º
        </div>

        <div class="main-content">
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-zone">
                    <div class="upload-icon">ğŸ“</div>
                    <h3>ä¸Šä¼ Excelæ–‡ä»¶</h3>
                    <p>æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                    <p style="color: #6c757d; font-size: 14px; margin-top: 10px;">
                        æ”¯æŒæ ¼å¼: .xlsx, .xls, .xlsm (æœ€å¤§50MB)
                    </p>
                </div>
                
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.xlsm">
                <button class="upload-btn" id="uploadBtn" onclick="document.getElementById('fileInput').click()">
                    é€‰æ‹©æ–‡ä»¶
                </button>

                <div class="file-info" id="fileInfo">
                    <h4>ğŸ“‹ æ–‡ä»¶ä¿¡æ¯</h4>
                    <div id="fileDetails"></div>
                </div>

                <div class="workflow-status" id="workflowStatus" style="display: none;">
                    <h4>ğŸ”„ å¤„ç†çŠ¶æ€</h4>
                    <div id="workflowSteps"></div>
                </div>
            </div>

            <!-- æŸ¥è¯¢åŒºåŸŸ -->
            <div class="query-section">
                <h3>ğŸ’¬ æ™ºèƒ½é—®ç­”</h3>
                <textarea 
                    class="query-input" 
                    id="queryInput" 
                    placeholder="è¯·è¾“å…¥ä½ æƒ³äº†è§£çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š&#10;â€¢ è¿™ä¸ªè¡¨æ ¼æœ‰å¤šå°‘è¡Œæ•°æ®ï¼Ÿ&#10;â€¢ é”€å”®é¢æœ€é«˜çš„æœˆä»½æ˜¯å“ªä¸ªï¼Ÿ&#10;â€¢ å¸®æˆ‘åˆ†æä¸€ä¸‹äº§å“ç±»åˆ«çš„åˆ†å¸ƒæƒ…å†µ&#10;â€¢ æ‰¾å‡ºå¼‚å¸¸å€¼æˆ–ç¦»ç¾¤ç‚¹"
                    disabled
                ></textarea>
                
                <button class="query-btn" id="queryBtn" onclick="submitQuery()" disabled>
                    ğŸš€ å¼€å§‹åˆ†æ
                </button>

                <div class="sample-queries">
                    <h4>ğŸ’¡ ç¤ºä¾‹é—®é¢˜</h4>
                    <div class="sample-query" onclick="setQuery('è¯·å¸®æˆ‘åˆ†æè¿™ä¸ªè¡¨æ ¼çš„åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯')">
                        ğŸ“ˆ è¯·å¸®æˆ‘åˆ†æè¿™ä¸ªè¡¨æ ¼çš„åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯
                    </div>
                    <div class="sample-query" onclick="setQuery('æ‰¾å‡ºæ•°æ®ä¸­çš„å¼‚å¸¸å€¼å’Œç¦»ç¾¤ç‚¹')">
                        ğŸ” æ‰¾å‡ºæ•°æ®ä¸­çš„å¼‚å¸¸å€¼å’Œç¦»ç¾¤ç‚¹
                    </div>
                    <div class="sample-query" onclick="setQuery('å„ä¸ªæ•°å€¼åˆ—ä¹‹é—´æœ‰ä»€ä¹ˆå…³è”å…³ç³»ï¼Ÿ')">
                        ğŸ”— å„ä¸ªæ•°å€¼åˆ—ä¹‹é—´æœ‰ä»€ä¹ˆå…³è”å…³ç³»ï¼Ÿ
                    </div>
                    <div class="sample-query" onclick="setQuery('ç”Ÿæˆä¸€ä¸ªæ•°æ®å¯è§†åŒ–å›¾è¡¨')">
                        ğŸ“Š ç”Ÿæˆä¸€ä¸ªæ•°æ®å¯è§†åŒ–å›¾è¡¨
                    </div>
                </div>
            </div>
        </div>

        <!-- å“åº”åŒºåŸŸ -->
        <div class="response-section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('response')">ğŸ“‹ åˆ†æç»“æœ</button>
                <button class="tab" onclick="switchTab('data')">ğŸ“Š æ•°æ®é¢„è§ˆ</button>
                <button class="tab" onclick="switchTab('code')">ğŸ’» ç”Ÿæˆä»£ç </button>
            </div>

            <div id="responseTab" class="tab-content active">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>AIæ­£åœ¨åˆ†æä¸­ï¼Œè¯·ç¨å€™...</p>
                </div>
                <div class="response-content" id="responseContent">
                    ğŸ‘‹ æ¬¢è¿ä½¿ç”¨Excelæ™ºèƒ½åˆ†æç³»ç»Ÿï¼
                    
è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤å¼€å§‹ï¼š
1. ä¸Šä¼ æ‚¨çš„Excelæ–‡ä»¶
2. ç­‰å¾…æ–‡ä»¶å¤„ç†å®Œæˆ
3. åœ¨å³ä¾§è¾“å…¥æ‚¨çš„é—®é¢˜
4. ç‚¹å‡»"å¼€å§‹åˆ†æ"è·å¾—AIå›å¤

ç³»ç»Ÿæ”¯æŒï¼š
â€¢ ğŸ“Š æ•°æ®ç»Ÿè®¡åˆ†æ
â€¢ ğŸ” å¼‚å¸¸å€¼æ£€æµ‹
â€¢ ğŸ“ˆ è¶‹åŠ¿åˆ†æ
â€¢ ğŸ“‹ æ•°æ®æ¸…æ´—å»ºè®®
â€¢ ğŸ¨ å¯è§†åŒ–å›¾è¡¨ç”Ÿæˆ

ç³»ç»ŸçŠ¶æ€æ­£åœ¨æ£€æŸ¥ä¸­...
                </div>
            </div>

            <div id="dataTab" class="tab-content">
                <div id="dataPreview">
                    <p>ä¸Šä¼ æ–‡ä»¶åå°†æ˜¾ç¤ºæ•°æ®é¢„è§ˆ...</p>
                </div>
            </div>

            <div id="codeTab" class="tab-content">
                <div id="generatedCode">
                    <p>åˆ†æå®Œæˆåå°†æ˜¾ç¤ºç”Ÿæˆçš„Pythonä»£ç ...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFile = null;
        let currentFileId = null;
        let systemStatus = null;
        let mockMode = false;

        // API base URL
        const API_BASE = '/api';

        // Initialize system
        document.addEventListener('DOMContentLoaded', () => {
            checkSystemStatus();
        });

        // Check system status
        async function checkSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                systemStatus = await response.json();
                
                updateSystemStatus();
                
                if (!systemStatus.agent_available) {
                    mockMode = true;
                    document.getElementById('mockModeBanner').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Failed to check system status:', error);
                showError('æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨');
            }
        }

        function updateSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            
            let statusItems = [];
            
            statusItems.push(`<span class="${systemStatus.agent_available ? 'status-ok' : 'status-warning'}">
                ${systemStatus.agent_available ? 'âœ…' : 'âš ï¸'} Agentç³»ç»Ÿ: ${systemStatus.agent_available ? 'æ­£å¸¸' : 'æ¼”ç¤ºæ¨¡å¼'}
            </span>`);
            
            statusItems.push(`<span class="${systemStatus.mcp_initialized ? 'status-ok' : 'status-warning'}">
                ${systemStatus.mcp_initialized ? 'âœ…' : 'âš ï¸'} MCP: ${systemStatus.mcp_initialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}
            </span>`);
            
            statusItems.push(`<span class="${systemStatus.orchestrator_ready ? 'status-ok' : 'status-warning'}">
                ${systemStatus.orchestrator_ready ? 'âœ…' : 'âš ï¸'} åè°ƒå™¨: ${systemStatus.orchestrator_ready ? 'å°±ç»ª' : 'æœªå°±ç»ª'}
            </span>`);
            
            statusDiv.innerHTML = statusItems.join('');
        }

        // File upload handling
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileDetails = document.getElementById('fileDetails');
        const queryInput = document.getElementById('queryInput');
        const queryBtn = document.getElementById('queryBtn');
        const uploadBtn = document.getElementById('uploadBtn');

        // Drag and drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        async function handleFile(file) {
            // Validate file
            const allowedTypes = ['.xlsx', '.xls', '.xlsm'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(fileExtension)) {
                showError('è¯·ä¸Šä¼ Excelæ–‡ä»¶ (.xlsx, .xls, .xlsm)');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                showError('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡50MB');
                return;
            }

            uploadedFile = file;
            displayFileInfo(file);
            await uploadFile(file);
        }

        function displayFileInfo(file) {
            const sizeInMB = (file.size / 1024 / 1024).toFixed(2);
            fileDetails.innerHTML = `
                <p><strong>æ–‡ä»¶å:</strong> ${file.name}</p>
                <p><strong>å¤§å°:</strong> ${sizeInMB} MB</p>
                <p><strong>ç±»å‹:</strong> ${file.type}</p>
                <p><strong>æœ€åä¿®æ”¹:</strong> ${new Date(file.lastModified).toLocaleString()}</p>
            `;
            fileInfo.classList.add('show');
        }

        async function uploadFile(file) {
            const workflowStatus = document.getElementById('workflowStatus');
            const workflowSteps = document.getElementById('workflowSteps');
            
            uploadBtn.disabled = true;
            workflowStatus.style.display = 'block';
            
            const steps = [
                { id: 'upload', name: 'ğŸ“¤ æ–‡ä»¶ä¸Šä¼ ' },
                { id: 'ingest', name: 'ğŸ“Š æ–‡ä»¶è§£æ' },
                { id: 'profile', name: 'ğŸ” æ•°æ®åˆ†æ' },
                { id: 'ready', name: 'âœ… å‡†å¤‡å°±ç»ª' }
            ];

            workflowSteps.innerHTML = steps.map(step => 
                `<div class="workflow-step">
                    <div class="step-status step-pending" id="status-${step.id}"></div>
                    <span>${step.name}</span>
                </div>`
            ).join('');

            try {
                // Upload file
                setStepStatus('upload', 'running');
                const formData = new FormData();
                formData.append('file', file);

                const uploadResponse = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    const error = await uploadResponse.json();
                    throw new Error(error.error || 'Upload failed');
                }

                const uploadResult = await uploadResponse.json();
                currentFileId = uploadResult.file_id;
                setStepStatus('upload', 'completed');

                // Process file
                setStepStatus('ingest', 'running');
                const processResponse = await fetch(`${API_BASE}/process/${currentFileId}`, {
                    method: 'POST'
                });

                if (!processResponse.ok) {
                    const error = await processResponse.json();
                    throw new Error(error.error || 'Processing failed');
                }

                const processResult = await processResponse.json();
                setStepStatus('ingest', 'completed');
                setStepStatus('profile', 'running');
                
                // Simulate processing steps
                await new Promise(resolve => setTimeout(resolve, 1500));
                setStepStatus('profile', 'completed');
                setStepStatus('ready', 'running');
                await new Promise(resolve => setTimeout(resolve, 500));
                setStepStatus('ready', 'completed');

                // Enable query interface
                queryInput.disabled = false;
                queryBtn.disabled = false;
                
                if (processResult.mock_mode) {
                    showWarning('æ–‡ä»¶å¤„ç†å®Œæˆï¼ç³»ç»Ÿè¿è¡Œåœ¨æ¼”ç¤ºæ¨¡å¼ä¸‹ï¼Œåˆ†æç»“æœä¸ºæ¨¡æ‹Ÿæ•°æ®ã€‚');
                } else {
                    showSuccess('æ–‡ä»¶å¤„ç†å®Œæˆï¼ç°åœ¨å¯ä»¥å¼€å§‹æé—®äº†ã€‚');
                }
                
                // Display data preview using backend HTML conversion
                await loadDataPreview();
                
            } catch (error) {
                showError('æ–‡ä»¶å¤„ç†å¤±è´¥: ' + error.message);
                setStepStatus('upload', 'error');
            } finally {
                uploadBtn.disabled = false;
            }
        }

        function setStepStatus(stepId, status) {
            const element = document.getElementById(`status-${stepId}`);
            if (element) {
                element.className = `step-status step-${status}`;
            }
        }

        async function loadDataPreview() {
            if (!currentFileId) {
                return;
            }

            const dataPreview = document.getElementById('dataPreview');
            dataPreview.innerHTML = '<div style="padding: 20px; text-align: center;">ğŸ“Š æ­£åœ¨ç”Ÿæˆæ•°æ®é¢„è§ˆ...</div>';

            try {
                const response = await fetch(`${API_BASE}/preview/${currentFileId}?max_rows=50&max_cols=10`);
                
                if (!response.ok) {
                    throw new Error('Failed to load preview');
                }

                const result = await response.json();
                
                if (result.success) {
                    displayDataPreview(result.html, result.metadata);
                } else {
                    dataPreview.innerHTML = `<div class="error">é¢„è§ˆå¤±è´¥: ${result.error}</div>`;
                }
            } catch (error) {
                console.error('Preview error:', error);
                dataPreview.innerHTML = `<div class="error">æ— æ³•åŠ è½½æ•°æ®é¢„è§ˆ: ${error.message}</div>`;
            }
        }

        function displayDataPreview(htmlContent, metadata) {
            const dataPreview = document.getElementById('dataPreview');
            
            const fileName = uploadedFile ? uploadedFile.name : 'æœªçŸ¥æ–‡ä»¶';
            
            let previewHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4>ğŸ“Š æ•°æ®é¢„è§ˆ - ${fileName}</h4>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="loadDataPreview()" style="padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;">ğŸ”„ åˆ·æ–°</button>
                            <button onclick="showFullPreview()" style="padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 3px; cursor: pointer;">ğŸ” æŸ¥çœ‹å®Œæ•´æ•°æ®</button>
                        </div>
                    </div>
                    
                    <div style="overflow: auto; max-height: 600px; border: 1px solid #ddd; border-radius: 5px;">
                        ${htmlContent}
                    </div>
            `;
            
            if (metadata) {
                previewHTML += `
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px;">
                        <strong>ğŸ“ˆ æ•°æ®æ¦‚è§ˆ:</strong><br>
                        â€¢ å·¥ä½œè¡¨: ${metadata.current_sheet || 'N/A'}<br>
                        â€¢ è¡Œæ•°: ${metadata.total_rows || 'N/A'} è¡Œ<br>
                        â€¢ åˆ—æ•°: ${metadata.total_cols || 'N/A'} åˆ—<br>
                        ${metadata.truncated && metadata.truncated.rows ? 'â€¢ âš ï¸ æ˜¾ç¤ºéƒ¨åˆ†æ•°æ®ï¼Œå¦‚éœ€æŸ¥çœ‹å…¨éƒ¨è¯·ç‚¹å‡»"æŸ¥çœ‹å®Œæ•´æ•°æ®"<br>' : ''}
                        ${metadata.sheet_names && metadata.sheet_names.length > 1 ? 
                            `â€¢ å…¶ä»–å·¥ä½œè¡¨: ${metadata.sheet_names.filter(s => s !== metadata.current_sheet).join(', ')}` : ''}
                    </div>
                `;
            }
            
            previewHTML += '</div>';
            
            dataPreview.innerHTML = previewHTML;
        }

        async function showFullPreview() {
            if (!currentFileId) {
                return;
            }

            const response = await fetch(`${API_BASE}/preview/${currentFileId}?max_rows=1000&max_cols=50`);
            const result = await response.json();
            
            if (result.success) {
                // Open in new window/tab with full preview
                const newWindow = window.open('', '_blank');
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>å®Œæ•´æ•°æ®é¢„è§ˆ - ${uploadedFile ? uploadedFile.name : 'æ•°æ®'}</title>
                        <meta charset="UTF-8">
                        <style>
                            body { font-family: 'Segoe UI', sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #ddd; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>ğŸ“Š å®Œæ•´æ•°æ®é¢„è§ˆ</h1>
                            <p>æ–‡ä»¶: ${uploadedFile ? uploadedFile.name : 'æœªçŸ¥æ–‡ä»¶'}</p>
                        </div>
                        <div style="overflow: auto;">
                            ${result.html}
                        </div>
                    </body>
                    </html>
                `);
                newWindow.document.close();
            } else {
                showError('æ— æ³•åŠ è½½å®Œæ•´é¢„è§ˆ: ' + result.error);
            }
        }

        async function submitQuery() {
            const query = queryInput.value.trim();
            if (!query) {
                showError('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜');
                return;
            }

            if (!currentFileId) {
                showError('è¯·å…ˆä¸Šä¼ å¹¶å¤„ç†Excelæ–‡ä»¶');
                return;
            }

            const loading = document.getElementById('loading');
            const responseContent = document.getElementById('responseContent');
            
            loading.classList.add('show');
            responseContent.style.display = 'none';
            queryBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        file_id: currentFileId,
                        query: query
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Query failed');
                }

                const result = await response.json();
                
                loading.classList.remove('show');
                responseContent.style.display = 'block';
                responseContent.textContent = result.response;

                // Display generated code
                if (result.generated_code) {
                    document.getElementById('generatedCode').innerHTML = `
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <h4>ğŸ’» ç”Ÿæˆçš„Pythonä»£ç </h4>
                            ${result.mock_mode ? '<div class="warning">âš ï¸ æ¼”ç¤ºæ¨¡å¼ - ä»£ç ä»…ä¾›å‚è€ƒ</div>' : ''}
                            <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto;"><code>${result.generated_code}</code></pre>
                        </div>
                    `;
                }

                queryBtn.disabled = false;
                
            } catch (error) {
                loading.classList.remove('show');
                showError('åˆ†æå¤±è´¥: ' + error.message);
                queryBtn.disabled = false;
            }
        }

        function setQuery(query) {
            document.getElementById('queryInput').value = query;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        function showError(message) {
            const responseContent = document.getElementById('responseContent');
            responseContent.innerHTML = `<div class="error">âŒ ${message}</div>`;
            responseContent.style.display = 'block';
        }

        function showSuccess(message) {
            const responseContent = document.getElementById('responseContent');
            responseContent.innerHTML = `<div class="success">âœ… ${message}</div>`;
            responseContent.style.display = 'block';
        }

        function showWarning(message) {
            const responseContent = document.getElementById('responseContent');
            responseContent.innerHTML = `<div class="warning">âš ï¸ ${message}</div>`;
            responseContent.style.display = 'block';
        }
    </script>
</body>
</html>